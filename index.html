<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Market Game</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ’°</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://apis.google.com/js/api.js"></script> <!-- Google API for Sheets -->
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #87CEEB, #4682B4);
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            width: 90%;
            max-width: 1200px;
            text-align: center;
            position: relative;
        }

        #password-screen {
            background: rgba(255, 255, 255, 0.9);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        #password-screen h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5em;
            margin-bottom: 20px;
            color: #4682B4;
        }

        select, #password-input {
            padding: 10px;
            font-size: 1.2em;
            border: 2px solid #4682B4;
            border-radius: 10px;
            width: 200px;
            margin: 10px;
        }

        #password-submit {
            padding: 10px 20px;
            font-size: 1.2em;
            background: #4682B4;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.3s;
        }

        #password-submit:hover {
            background: #5A9BD4;
        }

        #game-screen {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5em;
            color: #4682B4;
            margin-bottom: 20px;
        }

        #news {
            background: #E0F7FA;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 1.1em;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }

        th, td {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #4682B4;
            color: white;
            font-weight: 500;
        }

        tr:hover {
            background: #F0F8FF;
        }

        .flash {
            animation: flash 0.5s ease-in-out;
        }

        @keyframes flash {
            0% { background-color: #FFD700; }
            50% { background-color: #FFFF00; }
            100% { background-color: transparent; }
        }

        input[type="number"] {
            width: 60px;
            padding: 5px;
            border: 1px solid #4682B4;
            border-radius: 5px;
        }

        button {
            padding: 8px 15px;
            background: #4682B4;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
            margin: 0 5px;
        }

        button:hover {
            background: #5A9BD4;
            transform: scale(1.05);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #next-day {
            margin: 20px 0;
            padding: 15px 30px;
            font-size: 1.2em;
        }

        #portfolio {
            font-size: 1.2em;
            margin-bottom: 20px;
            font-weight: 500;
        }

        #chart-container {
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            table {
                font-size: 0.9em;
            }
            input[type="number"] {
                width: 50px;
            }
            button {
                padding: 6px 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="password-screen">
            <h1>Enter Details</h1>
            <select id="school-select">
                <option value="">Select School</option>
            </select>
            
            <select id="grade-select" disabled>
            <option value="">Select Grade</option>
            </select>
            
            <select id="name-select" disabled>
                <option value="">Select Name</option>
            </select>
            <input type="password" id="password-input" placeholder="Password" disabled>
            <button id="password-submit">Submit</button>
        </div>
        <div id="game-screen">
            <h1>Stock Market Simulator</h1>
            <div id="news">Welcome to the stock market! Watch for news events that affect prices.</div>
            <table id="stock-table">
                <thead>
                    <tr>
                        <th>Stock Name</th>
                        <th>Price (â‚¹)</th>
                        <th>Owned</th>
                        <th>Buy</th>
                        <th>Sell</th>
                    </tr>
                </thead>
                <tbody id="stock-body">
                    <!-- Stocks will be populated here -->
                </tbody>
            </table>
            <button id="next-day">Next Day</button>
            <button id="restart-game" style="display:none;">Restart Game</button>
            <div id="portfolio">Portfolio Value: â‚¹10,000 | Cash: â‚¹10,000</div>
            <div id="chart-container">
                <canvas id="stock-chart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Google Sheets API Configuration for Student Data
        const STUDENT_API_KEY = 'AIzaSyDQd2zlNNH1mXz6otZgSYywj9XkXfmL0QI'; // API Key for Student Data
        const STUDENT_SHEET_ID = '1KJP_B3kLUotGkt4w3vQjLtFUiC5XikqaAejIA4U14Tg'; // Sheet ID for Student Data
        const STUDENT_RANGE = 'Sheet1!A:E'; // Columns: Sr. No., School, Name, Password

        let studentData = [];
        let currentUser = null;

        // Load Google API for Student Data
        gapi.load('client', () => {
            gapi.client.init({
                apiKey: STUDENT_API_KEY,
                discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
            }).then(() => {
                fetchStudentData();
            });
        });

        function fetchStudentData() {
            gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: STUDENT_SHEET_ID,
                range: STUDENT_RANGE,
            }).then((response) => {
                const rows = response.result.values;
                if (rows.length > 1) {
                    studentData = rows.slice(1).map(row => ({
                        srNo: row[0],
                        school: row[1],
                        grade: row[2],
                        name: row[3],
                        password: row[4]
                    }));
                    populateSchools();
                }
            }).catch((error) => {
                console.error('Error fetching student data:', error);
                alert('Failed to load student data. Please try again later.');
            });
        }

        function populateSchools() {
    const schools = [...new Set(studentData.map(item => item.school))];
    const schoolSelect = document.getElementById('school-select');
    schools.forEach(school => {
        const option = document.createElement('option');
        option.value = school;
        option.textContent = school;
        schoolSelect.appendChild(option);
    });
}

/* âœ… ADD THIS RIGHT BELOW populateSchools() */
function populateGrades(selectedSchool) {
    const gradeSelect = document.getElementById('grade-select');
    gradeSelect.innerHTML = '<option value="">Select Grade</option>';

    const grades = [
        ...new Set(
            studentData
                .filter(item => item.school === selectedSchool)
                .map(item => item.grade)
        )
    ];

    grades.forEach(grade => {
        const option = document.createElement('option');
        option.value = grade;
        option.textContent = grade;
        gradeSelect.appendChild(option);
    });

    gradeSelect.disabled = false;
}

document.getElementById('school-select').addEventListener('change', (e) => {
    const selectedSchool = e.target.value;

    document.getElementById('grade-select').innerHTML =
        '<option value="">Select Grade</option>';
    document.getElementById('grade-select').disabled = true;
    document.getElementById('name-select').disabled = true;
    document.getElementById('password-input').disabled = true;

    if (selectedSchool) {
        populateGrades(selectedSchool);
    }
});

document.getElementById('grade-select').addEventListener('change', (e) => {
    const selectedGrade = e.target.value;
    const selectedSchool = document.getElementById('school-select').value;
    const nameSelect = document.getElementById('name-select');

    nameSelect.innerHTML = '<option value="">Select Name</option>';

    if (selectedGrade) {
        const names = studentData
            .filter(item =>
                item.school === selectedSchool &&
                item.grade === selectedGrade
            )
            .map(item => item.name);

        names.forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            nameSelect.appendChild(option);
        });

        nameSelect.disabled = false;
    }
});


        document.getElementById('name-select').addEventListener('change', (e) => {
            const passwordInput = document.getElementById('password-input');
            passwordInput.disabled = !e.target.value;
        });

        // Password Protection
        const passwordScreen = document.getElementById('password-screen');
        const gameScreen = document.getElementById('game-screen');
        const passwordInput = document.getElementById('password-input');
        const passwordSubmit = document.getElementById('password-submit');
        const schoolSelect = document.getElementById('school-select');
        const nameSelect = document.getElementById('name-select');

        passwordSubmit.addEventListener('click', () => {
    const selectedSchool = schoolSelect.value;
    const selectedGrade =
        document.getElementById('grade-select').value; // ðŸ‘ˆ ADD THIS
    const selectedName = nameSelect.value;
    const enteredPassword = passwordInput.value;

    const student = studentData.find(item =>
        item.school === selectedSchool &&
        item.grade === selectedGrade &&   // ðŸ‘ˆ ADD THIS
        item.name === selectedName
    );

    if (student && student.password === enteredPassword) {
        currentUser = `${selectedSchool}-${selectedGrade}-${selectedName}`;
        passwordScreen.style.display = 'none';
        gameScreen.style.display = 'block';
        initializeGame();
    } else {
        alert('Incorrect Password or Details âŒ');
    }
});

        // Game Variables
        let cash = 10000;
        let portfolioValue = 10000;
        let day = 1;
        let goodMoves = 0;
        let blunders = 0;
        const MAX_DAYS = 30;    
        let gameEnded = false;
        const initialStocks = [
            { name: 'JAS-47', price: 100, owned: 0, history: [100] },
            { name: 'Finstagram', price: 150, owned: 0, history: [150] },
            { name: 'CFDH Bank', price: 200, owned: 0, history: [200] },
            { name: 'Infokix', price: 80, owned: 0, history: [80] },
            { name: 'DMW', price: 120, owned: 0, history: [120] },
            { name: 'Artix', price: 90, owned: 0, history: [90] },
            { name: 'No Bank', price: 180, owned: 0, history: [180] },
            { name: 'Batata Steel', price: 110, owned: 0, history: [110] },
            { name: 'DNA Cosmetics', price: 95, owned: 0, history: [95] },
            { name: 'Devdas', price: 130, owned: 0, history: [130] }
        ];
        let stocks = JSON.parse(JSON.stringify(initialStocks)); // Deep copy

        const colorMap = {
            'JAS-47': '#FF6384',
            'Finstagram': '#36A2EB',
            'CFDH Bank': '#FFCE56',
            'Infokix': '#4BC0C0',
            'DMW': '#9966FF',
            'Artix': '#FF9F40',
            'No Bank': '#FF5733',
            'Batata Steel': '#33FF57',
            'DNA Cosmetics': '#3357FF',
            'Devdas': '#FF33A8'
        };
        let stockChart;
        const newsEvents = [
            { text: 'Market is bullish today! Most stocks are up.', effect: (stock) => stock.price *= 1.1 },
            { text: 'Market is bearish today! Most stocks are down.', effect: (stock) => stock.price *= 0.9 },
            { text: 'JAS-47 launches a new product, price soars!', effect: (stock) => stock.name === 'JAS-47' ? stock.price *= 1.3 : null },
            { text: 'Finstagram faces data breach, price plummets!', effect: (stock) => stock.name === 'Finstagram' ? stock.price *= 0.7 : null },
            { text: 'CFDH Bank reports record profits, stock rises!', effect: (stock) => stock.name === 'CFDH Bank' ? stock.price *= 1.2 : null },
            { text: 'Infokix hit by regulatory fines, stock falls!', effect: (stock) => stock.name === 'Infokix' ? stock.price *= 0.8 : null },
            { text: 'DMW acquires a competitor, stock surges!', effect: (stock) => stock.name === 'DMW' ? stock.price *= 1.25 : null },
            { text: 'Artix faces supply chain issues, stock dips!', effect: (stock) => stock.name === 'Artix' ? stock.price *= 0.85 : null },
            { text: 'No Bank expands internationally, stock climbs!', effect: (stock) => stock.name === 'No Bank' ? stock.price *= 1.15 : null },
            { text: 'Batata Steel wins major contract, stock jumps!', effect: (stock) => stock.name === 'Batata Steel' ? stock.price *= 1.2 : null },
            { text: 'DNA Cosmetics launches viral campaign, stock rises!', effect: (stock) => stock.name === 'DNA Cosmetics' ? stock.price *= 1.3 : null },
            { text: 'Devdas faces leadership turmoil, stock drops!', effect: (stock) => stock.name === 'Devdas' ? stock.price *= 0.75 : null }
        ];
        function initializeGame() {
            renderStockTable();
            updatePortfolioDisplay();
            initializeChart();
        }
        function renderStockTable() {
            const stockBody = document.getElementById('stock-body');
            stockBody.innerHTML = '';
            stocks.forEach((stock, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${stock.name}</td>
                    <td id="price-${index}">â‚¹${stock.price.toFixed(2)}</td>
                    <td id="owned-${index}">${stock.owned}</td>
                    <td>
                        <input type="number" id="buy-qty-${index}" min="1" value="1">
                        <button onclick="buyStock(${index})">Buy</button>
                    </td>
                    <td>
                        <input type="number" id="sell-qty-${index}" min="1" value="1">
                        <button onclick="sellStock(${index})">Sell</button>
                    </td>
                `;
                stockBody.appendChild(tr);
            });
        }
        function buyStock(index) {
            const qtyInput = document.getElementById(`buy-qty-${index}`);
            const quantity = parseInt(qtyInput.value);
            const stock = stocks[index];
            const cost = stock.price * quantity;
            if (quantity > 0 && cost <= cash) {
                stock.owned += quantity;
                cash -= cost;
                goodMoves++;
                flashRow(index);
                renderStockTable();
                updatePortfolioDisplay();
            } else {
                alert('Insufficient funds or invalid quantity!');
            }
        }
        function sellStock(index) {
            const qtyInput = document.getElementById(`sell-qty-${index}`);
            const quantity = parseInt(qtyInput.value);
            const stock = stocks[index];
            if (quantity > 0 && quantity <= stock.owned) {
                stock.owned -= quantity;
                cash += stock.price * quantity;
                goodMoves++;
                flashRow(index);
                renderStockTable();
                updatePortfolioDisplay();
            } else {
                alert('Insufficient stock owned or invalid quantity!');
            }
        }
        function flashRow(index) {
            const row = document.getElementById(`price-${index}`).parentElement;
            row.classList.add('flash');
            setTimeout(() => {
                row.classList.remove('flash');
            }, 500);
        }
        function nextDay() {
    if (day >= MAX_DAYS) {
        endGame();
        return;
    }

    day++;

    const event = newsEvents[Math.floor(Math.random() * newsEvents.length)];
    document.getElementById('news').textContent = `Day ${day}: ${event.text}`;

    stocks.forEach(stock => {
        const oldPrice = stock.price;
        event.effect(stock);

        const fluctuation = (Math.random() * 0.1) + 0.95;
        stock.price *= fluctuation;
        stock.price = Math.max(1, stock.price);

        stock.history.push(stock.price);

        if (stock.price < oldPrice * 0.9) {
            blunders++;
        }
    });

    renderStockTable();
    updatePortfolioDisplay();
    updateChart();

    if (day === MAX_DAYS) {
        endGame();
    }
}
        function endGame() {
    if (gameEnded) return;   // â›” stop double save
    gameEnded = true;
    updatePortfolioDisplay(); // ensure final value is correct

    document.getElementById('news').textContent =
        `Game Over! You completed ${MAX_DAYS} days ðŸŽ‰ Final Portfolio: â‚¹${portfolioValue.toFixed
(2)} | Good Moves: ${goodMoves} | Blunders: ${blunders}`;
    document.getElementById('next-day').style.display = 'none';
    document.getElementById('restart-game').style.display = 'inline-block';

    saveGameData();
}
        function updatePortfolioDisplay() {
            portfolioValue = cash + stocks.reduce((sum, stock) => sum + (stock.price * stock.owned), 0);
            document.getElementById('portfolio').textContent =
                `Portfolio Value: â‚¹${portfolioValue.toFixed(2)} | Cash: â‚¹${cash.toFixed(2)}`;
        }
        function initializeChart() {
            const ctx = document.getElementById('stock-chart').getContext('2d');
            stockChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({ length: day }, (_, i) => `Day ${i + 1}`),
                    datasets: stocks.map(stock => ({
                        label: stock.name,
                        data: stock.history,
                        borderColor: colorMap[stock.name],
                        fill: false,
                        tension: 0.1
                    }))
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Stock Price History'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        function updateChart() {
            stockChart.data.labels = Array.from({ length: day }, (_, i) => `Day ${i + 1}`);
            stockChart.data.datasets.forEach((dataset, index) => {
                dataset.data = stocks[index].history;
            });
            stockChart.update();
        }
        function resetGame() {
            if (!currentUser) {
                // No user logged in: show login screen
                passwordScreen.style.display = 'block';
                gameScreen.style.display = 'none';
                return;
            }

            // Reset core game state
            cash = 10000;
            portfolioValue = 10000;
            day = 1;
            goodMoves = 0;
            blunders = 0;
            gameEnded = false;

            // Deep copy initial stocks and reset history
            stocks = JSON.parse(JSON.stringify(initialStocks));
            stocks.forEach(stock => {
                stock.history = [stock.price];
                stock.owned = 0;
            });

            // Restore UI
            passwordScreen.style.display = 'none';
            gameScreen.style.display = 'block';
            document.getElementById('news').textContent = 'Welcome to the stock market! Watch for news events that affect prices.';
            document.getElementById('next-day').style.display = 'inline-block';
            document.getElementById('restart-game').style.display = 'none';

            // Re-render and re-init chart
            renderStockTable();
            updatePortfolioDisplay();
            if (stockChart) {
                try { stockChart.destroy(); } catch (e) { /* ignore */ }
            }
            initializeChart();
        }

        document.getElementById('next-day').addEventListener('click', nextDay);
        document.getElementById('restart-game').addEventListener('click', resetGame);
        // Save Game Data to Google Sheets
        const GAME_API_KEY = 'AIzaSyCqD3hX1mXz6otZgSYywj9XkXfmL0QI'; // API Key for Game Data
        const GAME_SHEET_ID = '1LJP_B3kLUotGkt4w3vQjLtFUiC5XikqaAejIA4U14Tg'; // Sheet ID for Game Data
        const GAME_RANGE = 'Sheet1!A:F'; // Columns: User, Date, Portfolio Value, Good Moves, Blunders, Days Played
        function saveGameData() {
            gapi.client.init({
                apiKey: GAME_API_KEY,
                discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
            }).then(() => {
                const date = new Date().toLocaleDateString();
                const values = [
                    [
                        currentUser,
                        date,
                        portfolioValue.toFixed(2),
                        goodMoves,
                        blunders,
                        day
                    ]
                ];
                const body = {
                    values: values
                };
                gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: GAME_SHEET_ID,
                    range: GAME_RANGE,
                    valueInputOption: 'RAW',
                    resource: body
                }).then((response) => {
                    console.log('Game data saved successfully:', response);
                }).catch((error) => {
                    console.error('Error saving game data:', error);
                });
            });
        }
    </script>
</body>
</html>
